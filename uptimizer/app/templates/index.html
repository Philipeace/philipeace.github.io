<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uptimizer Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {# Chart.js loaded via CDN in head #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body class="{{ 'floating-disabled' if app_settings.disable_floating_elements else '' }}">
    <!-- Container for Floating Elements -->
    <div class="floating-element-container" id="floating-elements"></div>

    <div class="container">
        <h1>Uptimizer - Keepin' Tabs on the Tabs</h1>

        <!-- Add New Endpoint Button -->
        <div class="add-edit-form-container">
             <button onclick="openAddEditModal(null)">+ Add New Endpoint</button>
        </div>

        <!-- Endpoint List -->
        {% if endpoints and endpoints | length > 0 %}
            {% for group, items in endpoints | groupby('group') %}
            <div class="group-container" data-group-name="{{ group if group else 'Default Group' }}">
                <div class="group-header" onclick="toggleGroup(this)"> <span class="group-title">{{ group if group else 'Default Group' }}</span> <span class="group-toggle">▼</span> </div>
                <div class="group-content">
                    <ul class="endpoint-list" id="endpoint-list-{{ group | escape | replace(' ', '-') | lower if group else 'default-group' }}">
                        {% for endpoint in items %}
                        <li class="endpoint-item" data-endpoint-id="{{ endpoint.id }}" id="endpoint-item-{{ endpoint.id }}" onclick="openHistoryModalMaybe(event, '{{ endpoint.id }}')">
                            <div class="endpoint-name">{{ endpoint.name }}</div>
                            <div class="endpoint-url">{{ endpoint.url }}</div>
                            <div class="endpoint-interval" id="interval-{{ endpoint.id }}"> <span class="value">--s</span> <span class="global">(global)</span> </div>
                            <div class="endpoint-timeout" id="timeout-{{ endpoint.id }}"> <span class="value">--s</span> <span class="global">(global)</span> </div>
                            <div class="endpoint-status status-unknown" id="status-{{ endpoint.id }}">PENDING</div>
                            <div class="endpoint-details" id="details-{{ endpoint.id }}"> </div>
                            <div class="endpoint-stats" id="stats-{{ endpoint.id }}">-- %</div>
                            <div class="endpoint-actions">
                                <button class="edit-btn" title="Edit Endpoint" onclick="openAddEditModal(event, '{{ endpoint.id }}')">✎</button>
                                <button class="delete-btn" title="Delete Endpoint" onclick="confirmDeleteEndpoint(event, '{{ endpoint.id }}')">×</button>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        {% else %}
             <div class="group-container" data-group-name="Default Group"> <div class="group-header" onclick="toggleGroup(this)"> <span class="group-title">Default Group</span> <span class="group-toggle">▼</span> </div> <div class="group-content"> <ul class="endpoint-list" id="endpoint-list-default-group"> <li id="no-endpoints-message" style="text-align: center; padding: 20px; font-style: italic;">No endpoints configured. Add one!</li> </ul> </div> </div>
        {% endif %}

         <!-- Template for new endpoint row -->
         <template id="endpoint-row-template">
            <li class="endpoint-item" data-endpoint-id="" id="" onclick="">
                <div class="endpoint-name"></div>
                <div class="endpoint-url"></div>
                <div class="endpoint-interval" id="">Int: <span class="value">--s</span> <span class="global">(global)</span></div>
                <div class="endpoint-timeout" id="">Timeout: <span class="value">--s</span> <span class="global">(global)</span></div>
                <div class="endpoint-status status-pending" id="">PENDING</div>
                <div class="endpoint-details" id=""> </div>
                <div class="endpoint-stats" id="">-- %</div>
                <div class="endpoint-actions">
                    <button class="edit-btn" title="Edit Endpoint" onclick="">✎</button>
                    <button class="delete-btn" title="Delete Endpoint" onclick="">×</button>
                </div>
            </li>
        </template>
    </div>

    <footer>
        <p>Uptimizer - Your friendly neighbourhood uptime bot.</p>
        <p id="footer-status">Initializing status checks...</p>
        <div id="settings-toggles">
            <button id="toggle-floating">Toggle Floating Elements</button>
            <button id="refresh-config-btn">Refresh Config from File</button> {# Added Reload Button #}
        </div>
    </footer>

    <!-- History Modal Structure -->
    <div class="modal-overlay history-modal" id="history-modal-overlay"> <div class="modal-content"> <button class="modal-close-btn" onclick="closeHistoryModal()">×</button> <div class="modal-header"> <h3 class="modal-title" id="history-modal-title">Endpoint History</h3> </div> <div class="modal-controls"> <button data-period="1h" onclick="changeHistoryPeriod(this)">Last Hour</button> <button data-period="24h" onclick="changeHistoryPeriod(this)" class="active">Last 24 Hours</button> <button data-period="7d" onclick="changeHistoryPeriod(this)">Last 7 Days</button> </div> <div class="modal-body"> <div class="modal-chart-container"> <canvas id="history-chart"></canvas> </div> <p id="history-modal-error" class="form-error-msg"></p> </div> </div> </div>

    <!-- Combined Add/Edit Modal Structure -->
    <div class="modal-overlay edit-modal" id="add-edit-modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeAddEditModal()">×</button>
            <div class="modal-header"> <h3 class="modal-title" id="add-edit-modal-title">Add/Edit Endpoint</h3> </div>
            <div class="modal-body">
                <form id="add-edit-endpoint-form" class="modal-form">
                    <input type="hidden" id="edit-endpoint-id" name="id">
                    <div class="form-group"> <label for="endpoint-name">Name:</label> <input type="text" id="endpoint-name" name="name" required> </div>
                    <div class="form-group"> <label for="endpoint-group">Group:</label> <input type="text" id="endpoint-group" name="group" placeholder="Default Group"> </div>
                    <div class="form-group form-group-full"> <label for="endpoint-url">URL:</label> <input type="text" id="endpoint-url" name="url" placeholder="https://example.com" required> <span class="url-warning" id="url-dot-warning" style="display: none;">(URL missing '.')</span> </div>
                    <div class="form-group"> <label for="endpoint-interval">Interval (s, opt):</label> <input type="number" id="endpoint-interval" name="check_interval_seconds" placeholder="{{ app_settings.check_interval_seconds | default(30) }}" min="5"> </div>
                    <div class="form-group"> <label for="endpoint-timeout">Timeout (s, opt):</label> <input type="number" id="endpoint-timeout" name="check_timeout_seconds" placeholder="{{ app_settings.check_timeout_seconds | default(10) }}" min="1"> </div>
                    <p id="add-edit-endpoint-error" class="form-error-msg form-group-full"></p>
                    <button type="submit" class="form-group-full">Save Endpoint</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal Structure -->
     <div class="modal-overlay confirm-modal" id="confirm-modal-overlay"> <div class="modal-content"> <button class="modal-close-btn" onclick="closeConfirmModal()">×</button> <div class="modal-header"> <h3 class="modal-title" id="confirm-modal-title">Confirm Action</h3> </div> <div class="modal-body confirm-body"> <p id="confirm-modal-message">Are you sure?</p> </div> <div class="modal-footer"> <button class="confirm-btn-no" id="confirm-no-btn">Cancel</button> <button class="confirm-btn-yes" id="confirm-yes-btn">Confirm</button> </div> </div> </div>

    {# Inject initial data for JavaScript #}
    <script>
        const initialEndpointData = {{ endpoint_data | default({}) | tojson }};
        const initialAppSettings = {{ app_settings | default({}) | tojson }};
    </script>
    {# Link external JavaScript file #}
    <script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>